<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HT Production Scheduler - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --primary: #3b82f6; 
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --border-color: #334155;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
        }
        body { 
            background-color: var(--bg-main); 
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: contain;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-input {
            width: 100%; padding: 0.5rem; border: 1px solid var(--border-color);
            border-radius: 0.5rem; background: #0f172a; font-size: 0.9rem;
            color: white;
            transition: all 0.2s;
        }
        .form-input:focus { border-color: #3b82f6; outline: none; ring: 2px; ring-color: #1e40af; }
        
        .col-qty { width: 50px; }
        .col-lot { width: 44px; }
        .col-gap { width: 62px; }
        .col-times { width: 75px; }
        
        th { 
            background: #1e293b; 
            color: #64748b; 
            padding: 0.5rem 0.25rem; 
            font-size: 0.6rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            font-weight: 800;
            border-bottom: 1px solid var(--border-color);
        }
        td { padding: 0.5rem 0.25rem; }
        
        .time-badge { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; 
            font-weight: 700; 
            letter-spacing: -0.05em;
        }
        
        .company-pill { height: 1.8rem; width: 4px; border-radius: 2px; margin-right: 6px; flex-shrink: 0; }
        
        .btn-tiny {
            padding: 0.4rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 800;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .nav-util-btn {
            padding: 0.5rem;
            border-radius: 0.75rem;
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-util-btn:hover {
            background: #334155;
            color: white;
        }

        .truncate-name {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 110px;
        }

        details summary::-webkit-details-marker { display:none; }
        details summary { list-style: none; }
        
        #edit-modal {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
            background-color: #1e293b;
        }
        #edit-modal.active {
            transform: translateY(0);
        }

        #sync-modal {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }
        #sync-modal.active {
            transform: translateY(0);
        }

        .row-colors-variety tr:nth-child(odd) { background-color: rgba(255, 255, 255, 0.02); }
        .row-colors-variety tr:hover { background-color: rgba(255, 255, 255, 0.05); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        select { color-scheme: dark; }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
        }
        .sync-indicator.synced { background: #065f46; color: #6ee7b7; }
        .sync-indicator.syncing { background: #1e40af; color: #93c5fd; }
        .sync-indicator.error { background: #7f1d1d; color: #fca5a5; }
        .sync-indicator.offline { background: #44403c; color: #d6d3d1; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="p-2 md:p-4 pb-20">

<div class="max-w-3xl mx-auto">
    <header class="mb-6 space-y-4">
        <div class="flex flex-row justify-between items-center px-1">
            <div class="flex items-center gap-1.5">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-lg shadow-blue-900/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h1 class="text-lg font-black text-slate-100 tracking-tighter">HT Scheduler</h1>
                <div id="sync-status" class="sync-indicator offline">
                    <span id="sync-icon">‚óè</span>
                    <span id="sync-text">Offline</span>
                </div>
            </div>
            
            <!-- Link Buttons to external HTML files -->
            <div class="flex items-center gap-2">
                <a href="OT.html" class="nav-util-btn" title="Overtime">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="ml-1 text-[10px] font-black hidden sm:inline">OT</span>
                </a>
                <a href="CALC.html" class="nav-util-btn" title="Calculator">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <span class="ml-1 text-[10px] font-black hidden sm:inline">CALC</span>
                </a>
                <a href="TIME.html" class="nav-util-btn" title="Time Log">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="ml-1 text-[10px] font-black hidden sm:inline">TIME</span>
                </a>
            </div>
        </div>

        <!-- Main Navigation Toggle -->
        <nav class="flex bg-slate-800/60 p-1 rounded-xl border border-slate-700 w-full">
            <button onclick="switchTab('daily')" id="tab-daily" class="flex-1 py-2 rounded-lg font-bold transition-all text-xs">Daily Schedule</button>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex-1 py-2 rounded-lg font-bold transition-all text-xs">Master Data</button>
        </nav>
    </header>

    <!-- SYNC SETUP TAB -->
    <div id="content-sync" class="tab-content hidden">
        <!-- Hidden - Config via modal only -->
    </div>

    <!-- FLOATING SYNC CONFIG BUTTON -->
    <button onclick="openSyncConfig()" class="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-2xl z-30 hover:bg-blue-500 transition-all hover:scale-110" title="Sync Configuration">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
    </button>

    <!-- SYNC CONFIG MODAL -->
    <div id="sync-modal-overlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-40 hidden" onclick="closeSyncConfig()"></div>
    <div id="sync-modal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl p-6 z-50 hidden flex-col shadow-2xl border-t border-slate-700 bg-slate-800 max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6"></div>
        <h3 class="text-sm font-black text-slate-200 uppercase mb-4 tracking-widest text-center">Sync Configuration</h3>
        
        <div class="space-y-4">
            <div class="bg-purple-900/20 border border-purple-800 rounded-xl p-4 space-y-2">
                <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-purple-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    <div class="text-xs text-purple-200 space-y-1">
                        <p class="font-bold">üì± Quick Setup:</p>
                        <ol class="list-decimal list-inside space-y-1 text-purple-300">
                            <li>Get <strong>Token</strong> and <strong>Gist ID</strong> from team</li>
                            <li>Paste them below</li>
                            <li>Click <strong>"Save & Download"</strong></li>
                            <li>All data will sync automatically!</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="bg-blue-900/20 border border-blue-800 rounded-xl p-4 space-y-2">
                <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div class="text-xs text-blue-200 space-y-1">
                        <p class="font-bold">First Time Setup:</p>
                        <ol class="list-decimal list-inside space-y-1 text-blue-300">
                            <li>Go to <a href="https://github.com/settings/tokens" target="_blank" class="underline font-bold">GitHub Tokens</a></li>
                            <li>Create token with <strong>gist</strong> permission</li>
                            <li>Paste token below</li>
                            <li>Leave Gist ID empty (auto-generated)</li>
                            <li>Click "Save & Download"</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-500 uppercase">GitHub Token</label>
                <input type="password" id="sync-modal-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="form-input h-10 bg-slate-900 font-mono text-xs">
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-500 uppercase">Gist ID (Optional)</label>
                <input type="text" id="sync-modal-gist" placeholder="Auto-generated or enter existing" class="form-input h-10 bg-slate-900 font-mono text-xs">
            </div>

            <div class="bg-emerald-900/20 border border-emerald-800 rounded-xl p-4">
                <h3 class="text-[10px] font-black text-emerald-400 uppercase tracking-wider mb-2">Current Data</h3>
                <div class="flex justify-around text-center">
                    <div>
                        <div class="text-2xl font-black text-emerald-400" id="modal-company-count">0</div>
                        <div class="text-[9px] text-emerald-300 uppercase">Companies</div>
                    </div>
                    <div>
                        <div class="text-2xl font-black text-emerald-400" id="modal-product-count">0</div>
                        <div class="text-[9px] text-emerald-300 uppercase">Products</div>
                    </div>
                </div>
            </div>

            <button onclick="saveAndSync()" class="w-full bg-blue-600 text-white py-4 rounded-xl text-sm font-bold shadow-lg shadow-blue-900/20 active:bg-blue-500">
                üíæ Save & Download Data
            </button>

            <button onclick="closeSyncConfig()" class="w-full bg-slate-700 text-slate-300 py-3 rounded-xl text-sm font-bold active:bg-slate-600">
                Cancel
            </button>

            <div class="bg-slate-900/50 rounded-xl p-4">
                <h3 class="text-[9px] font-black text-slate-400 uppercase tracking-wider mb-2">Activity Log</h3>
                <div id="modal-sync-log" class="text-[10px] text-slate-400 space-y-1 max-h-32 overflow-y-auto font-mono">
                    <p>Ready to sync...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- DAILY PRODUCTION -->
    <div id="content-daily" class="tab-content">
        <div class="bg-slate-800 p-3 rounded-2xl shadow-xl border border-slate-700 mb-3 space-y-3">
            <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-1">
                    <input type="time" id="shift-start" class="form-input font-bold text-sm h-9 py-0 px-2 w-24 bg-slate-900" onchange="calculateSchedule()">
                </div>
                
                <div class="flex gap-1.5">
                    <button onclick="resetDaily()" class="btn-tiny bg-slate-700 border border-slate-600 text-slate-300 active:bg-slate-600">Reset</button>
                    <button onclick="saveDaily()" class="btn-tiny bg-emerald-900/30 text-emerald-400 border border-emerald-800/50 active:bg-emerald-800/50">Save</button>
                    <button onclick="addRow()" class="btn-tiny bg-blue-600 text-white shadow-lg shadow-blue-900/20 active:bg-blue-500">+ Job</button>
                </div>
            </div>

            <div class="pt-2 border-t border-slate-700">
                <div class="relative">
                    <input type="text" id="daily-comp-search" placeholder="Search Company to Quick Add..." oninput="renderDailySearch()" class="form-input h-9 text-xs pl-9 bg-slate-900">
                    <svg class="w-4 h-4 absolute left-3 top-2.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <div id="daily-search-results" class="hidden mt-2 max-h-48 overflow-y-auto space-y-1.5 bg-slate-900/50 p-1.5 rounded-xl border border-slate-700"></div>
            </div>
        </div>

        <div class="overflow-hidden shadow-2xl rounded-2xl border border-slate-700 bg-slate-800">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead>
                        <tr>
                            <th class="pl-4" style="width: auto;">Job Details</th>
                            <th class="text-center col-qty">Qty</th>
                            <th class="text-center col-lot">Lot</th>
                            <th class="text-center col-gap">Gap</th>
                            <th class="col-times">Times</th>
                            <th class="pr-3 w-8"></th>
                        </tr>
                    </thead>
                    <tbody id="daily-body" class="row-colors-variety"></tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden p-12 text-center">
                <p class="text-slate-500 text-xs font-black uppercase tracking-widest">No jobs scheduled</p>
            </div>
        </div>
    </div>

    <!-- MASTER SETTINGS -->
    <div id="content-settings" class="tab-content">
        <div class="space-y-4">
            <div class="bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
                <h2 class="text-[10px] font-black text-slate-500 mb-3 uppercase tracking-widest">Register Company</h2>
                <div class="flex gap-2">
                    <input type="text" id="comp-name" placeholder="Company Name" class="form-input h-10 bg-slate-900">
                    <button onclick="saveCompany()" class="bg-slate-100 text-slate-900 px-5 rounded-xl text-xs font-bold active:bg-white">Add</button>
                </div>
                
                <details class="group mt-3" open>
                    <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-900/50 rounded-xl border border-slate-700/50">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-wider">Master Company List</span>
                        <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <ul id="company-list" class="space-y-1.5 mt-3 px-1"></ul>
                </details>
            </div>

            <div class="bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
                <h2 class="text-[10px] font-black text-slate-500 mb-3 uppercase tracking-widest">Register Product</h2>
                <div class="space-y-2">
                    <select id="prod-comp" class="form-input h-10 bg-slate-900"></select>
                    <input type="text" id="prod-name" placeholder="Product ID / Name" class="form-input h-10 bg-slate-900">
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" step="0.0001" id="prod-std" placeholder="Std Time" class="form-input h-10 bg-slate-900">
                        <input type="number" id="prod-qty" placeholder="Std Qty" class="form-input h-10 bg-slate-900">
                        <input type="number" id="prod-gap" placeholder="Gap (min)" class="form-input h-10 bg-slate-900">
                    </div>
                    <button onclick="saveProduct()" class="w-full bg-blue-600 text-white py-3 rounded-xl text-xs font-bold mt-2 shadow-lg shadow-blue-900/20 active:bg-blue-500">Add Product</button>
                </div>

                <details class="group mt-4">
                    <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-900/50 rounded-xl border border-slate-700/50">
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-wider">Master Product List</span>
                        <svg class="w-4 h-4 transition-transform group-open:rotate-180 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <ul id="product-list" class="space-y-1.5 mt-3 px-1 max-h-64 overflow-y-auto"></ul>
                </details>
            </div>
        </div>
    </div>

    <!-- MOBILE EDIT MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-md z-40 hidden" onclick="closeModal()"></div>
    <div id="edit-modal" class="fixed bottom-0 left-0 right-0 rounded-t-3xl p-6 z-50 hidden flex-col shadow-2xl border-t border-slate-700">
        <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6"></div>
        <h3 id="modal-title" class="text-sm font-black text-slate-200 uppercase mb-4 tracking-widest text-center">Edit Entry</h3>
        <div id="modal-content" class="space-y-4"></div>
        <div class="flex gap-3 mt-8">
            <button onclick="closeModal()" class="flex-1 py-3 bg-slate-800 text-slate-400 font-bold rounded-xl text-sm border border-slate-700">Cancel</button>
            <button onclick="confirmEdit()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl text-sm shadow-lg shadow-blue-900/20">Save Changes</button>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 opacity-0 transition-all duration-300 bg-white text-slate-900 px-6 py-2.5 rounded-full shadow-2xl z-50 text-[10px] font-black uppercase tracking-widest pointer-events-none">
        <span id="toast-msg">Saved</span>
    </div>
</div>

<script>
    const PRELOAD_COMPANIES = [
        "Ashahi", "FUZI SEIRA", "HOKUTO(ÂåóÊñó)", "Katsusika „Éç„Ç∏", "KHAMIDA", 
        "KOYA-UCHI", "NDN", "TAKAO(È´òÂ∞æ)", "Toushou(Êù±Ë®º)", "YAMAMOTO(Â±±Êú¨)", 
        "YOSIDA(ÂêâÁî∞)", "„Ç≥„Éº„Éû(KOMA)", "„Ç¥„Éà„Ç¶(GOTOU)", "„Ç≥„Éê„É¶(Kobayu)", 
        "„Éú„Éº„Çª„Ç§(Boshei)", "„É§„Çµ„Éà(Yasato)", "„É¶„Éº„Ç¶(Youu)", "‰ø°Âíå(Shinwa)", 
        "ÂÖ±Âíå(Kyowa)", "ÂâçÁî∞(Maeda)", "Â§™Áî∞(Oota)", "Â±±‰∏ã(Yamasita)", 
        "Êó•Á´†(Nissho)", "Êù±‰∫¨„É©„Çª„É≥(Tokyo Rasen)", "Êù±Ê¥ã(toyo)", 
        "Ê°ÇÂ∑ù(ktsuragawa)", "ÁßãÂ±±(AKIYAMA)", "Ëó§Â¥éÈã≤Ëû∫(fujisaki)", "Ëµ§ÁæΩ(Akabane)"
    ];

    // GitHub Gist Configuration
    let githubToken = localStorage.getItem('ht_github_token') || '';
    let gistId = localStorage.getItem('ht_gist_id') || '';

    let companies = JSON.parse(localStorage.getItem('ht_companies')) || [];
    let products = JSON.parse(localStorage.getItem('ht_products')) || [];
    let dailyJobs = JSON.parse(localStorage.getItem('ht_daily_save')) || [];
    let savedStartTime = localStorage.getItem('ht_start_time') || "08:00";
    
    let currentEditingType = null;
    let currentEditingId = null;

    if (companies.length === 0) {
        companies = PRELOAD_COMPANIES.map((name, index) => ({
            id: Date.now() + index,
            name: name
        }));
        companies.sort((a, b) => a.name.localeCompare(b.name));
        localStorage.setItem('ht_companies', JSON.stringify(companies));
    }

    const companyColors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8', '#a78bfa', '#f472b6', '#fb7185', '#fb923c', '#22d3ee'];

    // ============ SYNC FUNCTIONS ============
    function updateDataCounts() {
        const companyCount = companies.length;
        const productCount = products.length;
        
        document.getElementById('modal-company-count').textContent = companyCount;
        document.getElementById('modal-product-count').textContent = productCount;
    }

    function openSyncConfig() {
        document.getElementById('sync-modal-token').value = githubToken;
        document.getElementById('sync-modal-gist').value = gistId;
        updateDataCounts();
        toggleSyncModal(true);
    }

    function closeSyncConfig() {
        toggleSyncModal(false);
    }

    function toggleSyncModal(show) {
        const modal = document.getElementById('sync-modal');
        const overlay = document.getElementById('sync-modal-overlay');
        if(show) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }, 300);
            document.body.style.overflow = 'auto';
        }
    }

    function addModalLog(message) {
        const logEl = document.getElementById('modal-sync-log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.textContent = `[${timestamp}] ${message}`;
        logEl.insertBefore(logEntry, logEl.firstChild);
        
        while (logEl.children.length > 20) {
            logEl.removeChild(logEl.lastChild);
        }
    }

    async function saveAndSync() {
        const token = document.getElementById('sync-modal-token').value.trim();
        const gist = document.getElementById('sync-modal-gist').value.trim();
        
        if (!token) {
            showToast('Token required!');
            return;
        }
        
        githubToken = token;
        gistId = gist;
        
        localStorage.setItem('ht_github_token', githubToken);
        localStorage.setItem('ht_gist_id', gistId);
        
        addModalLog('Configuration saved');
        updateSyncStatus('offline', 'Configured');
        
        // Now sync
        await syncNowQuiet();
        
        showToast('Synced!');
        setTimeout(() => closeSyncConfig(), 1000);
    }
    
    function updateSyncStatus(status, text) {
        const statusEl = document.getElementById('sync-status');
        const iconEl = document.getElementById('sync-icon');
        const textEl = document.getElementById('sync-text');
        
        statusEl.className = 'sync-indicator ' + status;
        textEl.textContent = text;
        
        if (status === 'syncing') {
            iconEl.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
        } else {
            iconEl.textContent = '‚óè';
        }
    }

    function addSyncLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        addModalLog(message);
    }

    async function syncNowQuiet() {
        if (!githubToken) {
            return;
        }
        
        updateSyncStatus('syncing', 'Syncing...');
        addSyncLog('Starting background sync...');
        
        try {
            const data = {
                companies: companies,
                products: products,
                lastUpdated: new Date().toISOString()
            };
            
            const gistData = {
                description: "HT Production Scheduler - Master Data",
                public: false,
                files: {
                    "ht-scheduler-data.json": {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            let response;
            
            if (gistId) {
                addSyncLog('Updating cloud data...');
                response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
            } else {
                addSyncLog('Creating new cloud storage...');
                response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
            }
            
            if (response.ok) {
                const result = await response.json();
                
                if (!gistId) {
                    gistId = result.id;
                    localStorage.setItem('ht_gist_id', gistId);
                    document.getElementById('sync-modal-gist').value = gistId;
                    addSyncLog(`‚úì Cloud storage created: ${gistId}`);
                }
                
                updateSyncStatus('synced', 'Synced');
                addSyncLog('‚úì Upload complete');
                
                // Download to ensure we have latest
                await forceDownloadQuiet();
                
            } else {
                const error = await response.json();
                updateSyncStatus('error', 'Sync Failed');
                addSyncLog('‚úó Sync failed: ' + (error.message || 'Unknown error'));
            }
        } catch (error) {
            updateSyncStatus('error', 'Error');
            addSyncLog('‚úó Error: ' + error.message);
        }
    }

    async function forceDownloadQuiet() {
        if (!githubToken || !gistId) {
            return;
        }
        
        updateSyncStatus('syncing', 'Downloading...');
        addSyncLog('Downloading shared data...');
        
        try {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const gist = await response.json();
                const fileContent = gist.files['ht-scheduler-data.json'].content;
                const data = JSON.parse(fileContent);
                
                companies = data.companies || [];
                products = data.products || [];
                
                localStorage.setItem('ht_companies', JSON.stringify(companies));
                localStorage.setItem('ht_products', JSON.stringify(products));
                
                updateSyncStatus('synced', 'Up to date');
                addSyncLog('‚úì Downloaded successfully');
                addSyncLog(`  ‚Üí ${companies.length} companies, ${products.length} products`);
                
                renderSettings();
                renderDaily();
                updateDataCounts();
            } else {
                updateSyncStatus('error', 'Download Failed');
                addSyncLog('‚úó Download failed');
            }
        } catch (error) {
            updateSyncStatus('error', 'Error');
            addSyncLog('‚úó Error: ' + error.message);
        }
    }

    function addSyncLog(message) {
        const logEl = document.getElementById('sync-log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('p');
        logEntry.textContent = `[${timestamp}] ${message}`;
        logEl.insertBefore(logEntry, logEl.firstChild);
        
        // Keep only last 20 entries
        while (logEl.children.length > 20) {
            logEl.removeChild(logEl.lastChild);
        }
    }

    // Auto-sync on company/product save
    async function autoSync() {
        if (githubToken && gistId) {
            await syncNowQuiet();
        }
    }

    // ============ ORIGINAL FUNCTIONS (with auto-sync added) ============
    
    function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    }

    function saveToStorage() {
        localStorage.setItem('ht_companies', JSON.stringify(companies));
        localStorage.setItem('ht_products', JSON.stringify(products));
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`content-${tab}`).classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => {
            btn.classList.remove('bg-slate-700', 'text-white');
            btn.classList.add('text-slate-400');
        });
        const activeBtn = document.getElementById(`tab-${tab}`);
        activeBtn.classList.remove('text-slate-400');
        activeBtn.classList.add('bg-slate-700', 'text-white');

        if(tab === 'settings') renderSettings();
        if(tab === 'daily') { renderDaily(); renderDailySearch(); }
    }

    function toggleModal(show) {
        const modal = document.getElementById('edit-modal');
        const overlay = document.getElementById('modal-overlay');
        if(show) {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
            overlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        } else {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }, 300);
            document.body.style.overflow = 'auto';
        }
    }

    function openEditCompany(id) {
        const company = companies.find(c => c.id === id);
        if(!company) return;
        currentEditingType = 'company';
        currentEditingId = id;
        document.getElementById('modal-title').innerText = "Edit Company";
        document.getElementById('modal-content').innerHTML = `
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-500 uppercase">Company Name</label>
                <input type="text" id="edit-val-name" value="${company.name}" class="form-input h-12 bg-slate-900">
            </div>
        `;
        toggleModal(true);
    }

    function openEditProduct(id) {
        const prod = products.find(p => p.id === id);
        if(!prod) return;
        currentEditingType = 'product';
        currentEditingId = id;
        document.getElementById('modal-title').innerText = "Edit Product";
        document.getElementById('modal-content').innerHTML = `
            <div class="space-y-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-500 uppercase">Product Name</label>
                    <input type="text" id="edit-val-name" value="${prod.name}" class="form-input h-12 bg-slate-900">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase">Std Time</label>
                        <input type="number" step="0.0001" id="edit-val-std" value="${prod.std}" class="form-input h-12 bg-slate-900">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase">Gap (min)</label>
                        <input type="number" id="edit-val-gap" value="${prod.gap}" class="form-input h-12 bg-slate-900">
                    </div>
                </div>
            </div>
        `;
        toggleModal(true);
    }

    function confirmEdit() {
        const name = document.getElementById('edit-val-name').value.trim();
        if(!name) return;
        if(currentEditingType === 'company') {
            const index = companies.findIndex(c => c.id === currentEditingId);
            if(index !== -1) companies[index].name = name;
        } else if(currentEditingType === 'product') {
            const std = parseFloat(document.getElementById('edit-val-std').value);
            const gap = parseInt(document.getElementById('edit-val-gap').value);
            const index = products.findIndex(p => p.id === currentEditingId);
            if(index !== -1) {
                products[index].name = name;
                products[index].std = std;
                products[index].gap = gap;
            }
        }
        saveToStorage();
        renderSettings();
        closeModal();
        showToast('Updated');
        autoSync(); // Auto-sync after edit
    }

    function closeModal() { toggleModal(false); }

    function saveCompany() {
        const nameEl = document.getElementById('comp-name');
        const name = nameEl.value.trim();
        if(!name) return;
        companies.push({ id: Date.now(), name });
        companies.sort((a, b) => a.name.localeCompare(b.name));
        saveToStorage();
        nameEl.value = '';
        renderSettings();
        autoSync(); // Auto-sync after adding
    }

    function saveProduct() {
        const compEl = document.getElementById('prod-comp');
        const nameEl = document.getElementById('prod-name');
        const stdEl = document.getElementById('prod-std');
        const qtyEl = document.getElementById('prod-qty');
        const gapEl = document.getElementById('prod-gap');
        const compId = parseInt(compEl.value);
        const name = nameEl.value.trim();
        const std = parseFloat(stdEl.value);
        const gap = parseInt(gapEl.value) || 30;
        if(!compId || !name || isNaN(std)) return;
        products.push({ id: Date.now(), compId, name, std, qty: parseFloat(qtyEl.value) || 0, gap });
        products.sort((a, b) => a.name.localeCompare(b.name));
        saveToStorage();
        nameEl.value = ''; stdEl.value = ''; qtyEl.value = ''; gapEl.value = '';
        renderSettings();
        autoSync(); // Auto-sync after adding
    }

    function getCompanyColor(compId) {
        const index = companies.findIndex(c => c.id == compId);
        return index !== -1 ? companyColors[index % companyColors.length] : '#334155';
    }

    function renderSettings() {
        document.getElementById('company-list').innerHTML = companies.map(c => `
            <li class="flex justify-between items-center p-2 bg-slate-800 border border-slate-700 rounded-xl text-[11px] font-bold shadow-sm">
                <div class="flex items-center flex-grow pl-1">
                    <div class="w-2 h-4 rounded-full mr-2" style="background-color: ${getCompanyColor(c.id)}"></div>
                    <span class="text-slate-200">${c.name}</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openEditCompany(${c.id})" class="p-2.5 bg-slate-700 text-blue-400 rounded-lg active:bg-slate-600">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </button>
                    <button onclick="deleteCompany(${c.id})" class="p-2.5 bg-slate-700 text-red-400 rounded-lg active:bg-slate-600">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                    </button>
                </div>
            </li>`).join('');
            
        document.getElementById('product-list').innerHTML = products.map(p => {
            const comp = companies.find(c => c.id == p.compId);
            return `
            <li class="flex justify-between items-center p-2.5 bg-slate-800 border border-slate-700 rounded-xl text-[11px] font-bold shadow-sm">
                <div class="flex flex-col flex-grow pl-1">
                    <span class="text-slate-100">${p.name}</span>
                    <span class="text-[9px] text-slate-500 font-normal uppercase tracking-tight">${comp ? comp.name : 'Unknown'} ‚Ä¢ Std: ${p.std} ‚Ä¢ Gap: ${p.gap}m</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openEditProduct(${p.id})" class="p-2.5 bg-slate-700 text-blue-400 rounded-lg active:bg-slate-600">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </button>
                    <button onclick="deleteProduct(${p.id})" class="p-2.5 bg-slate-700 text-red-400 rounded-lg active:bg-slate-600">
                         <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                    </button>
                </div>
            </li>`}).join('');
            
        document.getElementById('prod-comp').innerHTML = '<option value="">Select Company...</option>' + 
            companies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    function deleteCompany(id) { 
        if(confirm("Delete company?")) { 
            companies = companies.filter(c => c.id !== id); 
            saveToStorage(); 
            renderSettings(); 
            autoSync(); 
        } 
    }
    
    function deleteProduct(id) { 
        if(confirm("Delete product?")) { 
            products = products.filter(p => p.id !== id); 
            saveToStorage(); 
            renderSettings(); 
            autoSync(); 
        } 
    }

    function renderDailySearch() {
        const searchVal = document.getElementById('daily-comp-search').value.toLowerCase();
        const resultsEl = document.getElementById('daily-search-results');
        if (!searchVal) { resultsEl.classList.add('hidden'); return; }
        const filtered = companies.filter(c => c.name.toLowerCase().includes(searchVal));
        resultsEl.innerHTML = filtered.map(c => `
            <div class="flex items-center justify-between bg-slate-800 border border-slate-700 rounded-xl p-2 shadow-sm">
                <div class="flex items-center">
                    <div class="w-1.5 h-4 rounded-full mr-2" style="background-color: ${getCompanyColor(c.id)}"></div>
                    <span class="text-xs font-bold text-slate-200">${c.name}</span>
                </div>
                <button onclick="addJobByCompany(${c.id})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-tight">Add</button>
            </div>
        `).join('') || '<p class="text-center text-[10px] py-2 text-slate-500">No matches</p>';
        resultsEl.classList.remove('hidden');
    }

    function addRow() { dailyJobs.push({ compId: '', prodId: '', qty: 0, lot: 1, gap: 30 }); renderDaily(); }
    function addJobByCompany(compId) { dailyJobs.push({ compId: compId, prodId: '', qty: 0, lot: 1, gap: 30 }); document.getElementById('daily-comp-search').value = ''; renderDailySearch(); calculateSchedule(); showToast('Added'); }

    function updateJob(index, field, value) {
        const job = dailyJobs[index];
        job[field] = value;
        if (field === 'compId') job.prodId = '';
        if (field === 'prodId') {
            const prod = products.find(p => p.id == value);
            if(prod) { job.qty = prod.qty || 0; job.gap = prod.gap || 30; }
        }
        calculateSchedule();
    }

    function calculateSchedule() {
        const timeValue = document.getElementById('shift-start').value;
        if (!timeValue) return;
        const [hours, minutes] = timeValue.split(':');
        let timeline = new Date();
        timeline.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        dailyJobs.forEach((job) => {
            const prod = products.find(p => p.id == job.prodId);
            job.startTime = new Date(timeline);
            let baseDuration = 0;
            if (prod) baseDuration = Math.round(parseFloat(job.qty) * parseFloat(prod.std)) + ((parseInt(job.lot) - 1) * 10);
            job.durationMinutes = baseDuration;
            job.endTime = new Date(job.startTime.getTime() + (baseDuration * 60000));
            timeline = new Date(job.endTime.getTime() + ((parseInt(job.gap) || 0) * 60000));
        });
        renderDaily();
    }

    function formatT(date) { return date ? new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : "--:--"; }
    function formatDuration(min) { return min > 60 ? `${Math.floor(min/60)}h ${min%60}m` : `${min}m`; }

    function renderDaily() {
        const tbody = document.getElementById('daily-body');
        if (dailyJobs.length === 0) { tbody.innerHTML = ''; document.getElementById('empty-state').classList.remove('hidden'); return; }
        document.getElementById('empty-state').classList.add('hidden');
        tbody.innerHTML = dailyJobs.map((job, idx) => {
            const filteredProds = products.filter(p => p.compId == job.compId);
            return `
            <tr class="border-b border-slate-700/50">
                <td class="pl-4 py-3">
                    <div class="flex items-center">
                        <div class="company-pill" style="background-color: ${getCompanyColor(job.compId)}"></div>
                        <div class="min-w-0">
                            <select onchange="updateJob(${idx}, 'compId', this.value)" class="form-input text-[11px] font-black border-none p-0 h-4 focus:ring-0 bg-transparent truncate-name appearance-none text-slate-100">
                                <option value="" class="bg-slate-800">Company...</option>
                                ${companies.map(c => `<option value="${c.id}" ${job.compId == c.id ? 'selected' : ''} class="bg-slate-800">${c.name}</option>`).join('')}
                            </select>
                            <select onchange="updateJob(${idx}, 'prodId', this.value)" class="form-input text-[10px] text-slate-400 font-bold border-none p-0 h-4 focus:ring-0 bg-transparent truncate-name appearance-none">
                                <option value="" class="bg-slate-800">Product...</option>
                                ${filteredProds.map(p => `<option value="${p.id}" ${job.prodId == p.id ? 'selected' : ''} class="bg-slate-800">${p.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </td>
                <td class="text-center col-qty">
                    <input type="number" value="${job.qty}" onchange="updateJob(${idx}, 'qty', this.value)" class="form-input text-xs w-11 text-center font-bold p-1 h-8 bg-slate-900 border-slate-700">
                </td>
                <td class="text-center col-lot">
                    <input type="number" value="${job.lot}" onchange="updateJob(${idx}, 'lot', this.value)" class="form-input text-xs w-9 text-center font-bold p-1 h-8 bg-slate-900 border-slate-700">
                </td>
                <td class="text-center col-gap">
                    <input type="number" value="${job.gap}" onchange="updateJob(${idx}, 'gap', this.value)" class="form-input text-xs w-11 text-center font-bold p-1 h-8 bg-slate-900 border-slate-700">
                </td>
                <td class="col-times">
                    <div class="flex flex-col leading-none">
                        <span class="text-blue-400 time-badge text-[10px]">${formatT(job.startTime)}</span>
                        <span class="text-[7px] font-black text-slate-500 py-0.5 uppercase">${formatDuration(job.durationMinutes)}</span>
                        <span class="text-emerald-400 time-badge text-[10px]">${formatT(job.endTime)}</span>
                    </div>
                </td>
                <td class="pr-3 text-right">
                    <button onclick="dailyJobs.splice(${idx}, 1); calculateSchedule();" class="p-2 text-slate-600 active:text-red-500 transition-colors">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/></svg>
                    </button>
                </td>
            </tr>`;
        }).join('');
    }

    function saveDaily() { localStorage.setItem('ht_daily_save', JSON.stringify(dailyJobs)); localStorage.setItem('ht_start_time', document.getElementById('shift-start').value); showToast('Daily Saved'); }
    function resetDaily() { if(confirm("Clear daily?")) { dailyJobs = []; localStorage.removeItem('ht_daily_save'); renderDaily(); showToast('Cleared'); } }

    window.onload = async () => {
        document.getElementById('shift-start').value = savedStartTime;
        switchTab('daily');
        if(dailyJobs.length > 0) calculateSchedule();
        
        // Check if we have valid config on load and auto-download
        if (githubToken && gistId) {
            updateSyncStatus('syncing', 'Loading...');
            addSyncLog('App loaded - downloading shared data...');
            try {
                await forceDownloadQuiet();
                addSyncLog('‚úì Auto-sync complete');
            } catch (error) {
                updateSyncStatus('offline', 'Ready');
                addSyncLog('Auto-sync failed - you can sync manually');
            }
        } else {
            updateSyncStatus('offline', 'Not Configured');
            addSyncLog('App loaded - click settings button to configure sync');
            
            // Show config modal after 2 seconds if not configured
            setTimeout(() => {
                if (!githubToken) {
                    openSyncConfig();
                }
            }, 2000);
        }
    };
</script>
</body>
</html>
